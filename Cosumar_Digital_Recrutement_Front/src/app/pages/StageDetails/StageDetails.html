<div class="stage-details-content">
  <div class="page-header">
    <button class="back-btn" (click)="goBack()">
      <i class="icon-arrow-left"></i>
      Retour
    </button>
    <div class="header-info">
      <h2>D√©tails du Stage</h2>
      @if (stageData()?.stagiaire) {
        <p>{{ stageData()!.stagiaire.prenom }} {{ stageData()!.stagiaire.nom }} - {{ getNatureText(stageData()!.nature) }}</p>
      }
    </div>
    <div class="header-actions">
      @if (!isEditMode()) {
        <button class="edit-btn" (click)="toggleEditMode()">
          <i class="icon-edit"></i>
          Modifier
        </button>
      } @else {
        <button class="save-btn" (click)="saveChanges()" [disabled]="isSaving()">
          @if (isSaving()) {
            <span class="spinner"></span>
          } @else {
            <i class="icon-save"></i>
          }
          Enregistrer
        </button>
        <button class="cancel-btn" (click)="cancelEdit()">
          <i class="icon-cancel"></i>
          Annuler
        </button>
      }
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner large"></div>
      <p>Chargement des d√©tails du stage...</p>
    </div>
  }

  <!-- Error State -->
  @else if (errorMessage()) {
    <div class="error-container">
      <div class="error-message">
        <h3>Erreur</h3>
        <p>{{ errorMessage() }}</p>
        <button (click)="goBack()" class="retry-btn">Retour √† la liste</button>
      </div>
    </div>
  }

  <!-- Stage Details -->
  @else if (stageData()) {
    <div class="stage-details">
      
      <!-- Stagiaire Information -->
      <div class="details-section readonly-section">
        <div class="section-header">
          <h3>Informations du Stagiaire</h3>
          <span class="readonly-badge">
            <i class="icon-lock"></i>
            Non modifiable
          </span>
        </div>
        @if (stageData()?.stagiaire) {
          <div class="form-grid">
            <div class="form-group">
              <label>Matricule</label>
              <div class="form-value readonly">{{ stageData()!.stagiaire.matricule }}</div>
            </div>
            <div class="form-group">
              <label>Nom</label>
              <div class="form-value readonly">{{ stageData()!.stagiaire.nom }}</div>
            </div>
            <div class="form-group">
              <label>Pr√©nom</label>
              <div class="form-value readonly">{{ stageData()!.stagiaire.prenom }}</div>
            </div>
            <div class="form-group">
              <label>Email</label>
              <div class="form-value readonly">{{ stageData()!.stagiaire.email || 'Non renseign√©' }}</div>
            </div>
            <div class="form-group">
              <label>T√©l√©phone</label>
              <div class="form-value readonly">{{ stageData()!.stagiaire.num_tel || 'Non renseign√©' }}</div>
            </div>
            <div class="form-group">
              <label>Date de naissance</label>
              <div class="form-value readonly">{{ stageData()!.stagiaire.date_naissance || 'Non renseign√©e' }}</div>
            </div>
          </div>
          <div class="readonly-notice">
            <i class="icon-info"></i>
            <span>Les informations du stagiaire ne peuvent pas √™tre modifi√©es depuis cette page. Pour modifier ces donn√©es, veuillez contacter l'administrateur.</span>
          </div>
        }
      </div>

      <!-- Stage Information -->
      <div class="details-section">
        <h3>Informations du Stage</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="nature">Nature du stage</label>
            @if (isEditMode()) {
              <select 
                id="nature"
                [value]="stageData()!.nature || ''" 
                (change)="updateStageData('nature', $event)"
                class="form-control"
              >
                <option value="stage_observation">Stage d'observation</option>
                <option value="pfe">PFE</option>
                <option value="stage_application">Stage d'application</option>
              </select>
            } @else {
              <div class="form-value">{{ getNatureText(stageData()!.nature) }}</div>
            }
          </div>
          
          <div class="form-group">
            <label for="statut">Statut</label>
            @if (isEditMode()) {
              <select 
                id="statut"
                [value]="stageData()!.statut || ''" 
                (change)="updateStageData('statut', $event)"
                class="form-control"
              >
                <option value="en_attente_depot_dossier">En attente de d√©p√¥t de dossier</option>
                <option value="en_attente_visite_medicale">En attente de visite m√©dicale</option>
                <option value="en_attente_des_signatures">En attente de signatures</option>
                <option value="stage_en_cours">Stage en cours</option>
                <option value="en_attente_depot_rapport">En attente de d√©p√¥t de rapport</option>
                <option value="en_attente_signature_du_rapport_par_l_encadrant">En attente de signature du rapport par l'encadrant</option>
                <option value="termine">Termin√©</option>
                <option value="expire">Expir√©</option>
                <option value="annule">Annul√©</option>
              </select>
            } @else {
              <div class="form-value">
                <span class="status-badge" [style.background-color]="getStatusColor(stageData()!.statut)">
                  {{ getStatusText(stageData()!.statut) }}
                </span>
              </div>
            }
          </div>
          
          <div class="form-group">
            <label for="date_debut">Date de d√©but</label>
            @if (isEditMode()) {
              <input 
                type="date" 
                id="date_debut"
                [value]="stageData()!.date_debut || ''" 
                (input)="updateStageData('date_debut', $event)"
                class="form-control"
              >
            } @else {
              <div class="form-value">{{ stageData()!.date_debut | date:'dd/MM/yyyy' }}</div>
            }
          </div>
          
          <div class="form-group">
            <label for="date_fin">Date de fin</label>
            @if (isEditMode()) {
              <input 
                type="date" 
                id="date_fin"
                [value]="stageData()!.date_fin || ''" 
                (input)="updateStageData('date_fin', $event)"
                class="form-control"
              >
            } @else {
              <div class="form-value">{{ stageData()!.date_fin | date:'dd/MM/yyyy' }}</div>
            }
          </div>

          <div class="form-group">
            <label for="prolongation">Date de prolongation</label>
            @if (isEditMode() && stageData()!.statut === 'stage_en_cours') {
              <input 
                type="date" 
                id="prolongation"
                [value]="stageData()!.prolongation || ''" 
                (input)="updateStageData('prolongation', $event)"
                class="form-control"
                placeholder="S√©lectionner une date de prolongation"
              >
              <small class="form-text">Laissez vide si aucune prolongation n'est pr√©vue</small>
            } @else {
              <div class="form-value">
                @if (stageData()!.prolongation) {
                  <span class="prolongation-date">{{ stageData()!.prolongation | date:'dd/MM/yyyy' }}</span>
                  <span class="prolongation-badge">Prolong√©</span>
                } @else {
                  <span class="no-prolongation">Aucune prolongation</span>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Subject Information -->
      <div class="details-section">
        <h3>Sujet de Stage</h3>
        @if (stageData()?.sujet && !isEditMode()) {
          <!-- Read-only view -->
          <div class="form-group">
            <label>Titre</label>
            <div class="form-value">{{ stageData()!.sujet!.titre }}</div>
          </div>
          <div class="form-group">
            <label>Description</label>
            <div class="form-value description">{{ stageData()!.sujet!.description }}</div>
          </div>
        } @else if (isEditMode()) {
          <!-- Edit mode with sujet selection -->
          <p class="form-note">Recherchez et assignez un sujet sp√©cifique pour ce stage :</p>
          
          <div class="form-group">
            <label for="sujet-search">Rechercher un sujet</label>
            <div class="search-container">
              <input 
                type="text"
                id="sujet-search"
                [value]="sujetSearchQuery()"
                (input)="onSujetSearchQueryChange($event)"
                placeholder="Rechercher par titre ou description..."
                class="search-input"
              >
              <i class="search-icon">üîç</i>
            </div>
            
            @if (isLoadingSujets()) {
              <div class="search-loading">
                <span class="spinner small"></span>
                <span>Recherche en cours...</span>
              </div>
            }
            
            @if (sujetSearchQuery() && filteredSujets().length > 0) {
              <div class="search-results">
                @for (sujet of filteredSujets(); track sujet.id) {
                  <div 
                    class="sujet-item"
                    [class.selected]="stageData()?.sujet?.id === sujet.id"
                    (click)="selectSujet(sujet)"
                  >
                    <div class="sujet-item-info">
                      <span class="sujet-title">{{ sujet.titre }}</span>
                      @if (sujet.description) {
                        <span class="sujet-description">{{ sujet.description | slice:0:100 }}{{ sujet.description.length > 100 ? '...' : '' }}</span>
                      }
                    </div>
                  </div>
                }
              </div>
            }
            
            @if (sujetSearchQuery() && filteredSujets().length === 0 && !isLoadingSujets() && !stageData()?.sujet) {
              <div class="no-results">
                <p>Aucun sujet trouv√© pour "{{ sujetSearchQuery() }}"</p>
              </div>
            }
          </div>
          
          @if (stageData()?.sujet) {
            <div class="sujet-preview">
              <h4>Sujet s√©lectionn√©</h4>
              <div class="sujet-info">
                <p><strong>Titre:</strong> {{ stageData()!.sujet!.titre }}</p>
                @if (stageData()?.sujet?.description) {
                  <p><strong>Description:</strong> {{ stageData()!.sujet!.description }}</p>
                }
              </div>
              <button type="button" class="clear-selection-btn" (click)="clearSujetSelection()">
                Changer de sujet
              </button>
            </div>
          }
        } @else {
          <!-- No sujet assigned -->
          <div class="no-subject-message">
            <p>Aucun sujet assign√© √† ce stage.</p>
            <p><small>Activez le mode √©dition pour assigner un sujet.</small></p>
          </div>
        }
      </div>

      <!-- Documents -->
      <div class="details-section">
        <h3>Documents</h3>
        <div class="documents-grid two-columns">
          
          <!-- CIN -->
          @if (cinPreviewUrl()) {
            <div class="document-item">
              <h4>CIN du stagiaire</h4>
              <div class="document-preview">
                <iframe [src]="cinPreviewUrl()!" class="document-iframe"></iframe>
              </div>
            </div>
          }

          <!-- CV -->
          @if (cvPreviewUrl()) {
            <div class="document-item">
              <h4>CV</h4>
              <div class="document-preview">
                <iframe [src]="cvPreviewUrl()!" class="document-iframe"></iframe>
              </div>
            </div>
          }

          <!-- Convention -->
          @if (conventionPreviewUrl()) {
            <div class="document-item">
              <h4>Convention de stage</h4>
              <div class="document-preview">
                <iframe [src]="conventionPreviewUrl()!" class="document-iframe"></iframe>
              </div>
            </div>
          }

          <!-- Assurance -->
          @if (assurancePreviewUrl()) {
            <div class="document-item">
              <h4>Assurance</h4>
              <div class="document-preview">
                <iframe [src]="assurancePreviewUrl()!" class="document-iframe"></iframe>
              </div>
            </div>
          }

          <!-- Lettre de motivation -->
          @if (lettreMotivationPreviewUrl()) {
            <div class="document-item">
              <h4>Lettre de motivation</h4>
              <div class="document-preview">
                <iframe [src]="lettreMotivationPreviewUrl()!" class="document-iframe"></iframe>
              </div>
            </div>
          }

          <!-- Demande de stage -->
          @if (demandeStagePreviewUrl()) {
            <div class="document-item">
              <h4>Demande de stage</h4>
              <div class="document-preview">
                <iframe [src]="demandeStagePreviewUrl()!" class="document-iframe"></iframe>
              </div>
            </div>
          }

        </div>
      </div>

      <!-- Document Management Section -->
      @if (stageData()?.statut === 'en_attente_depot_dossier' || isEditMode()) {
        <div class="details-section">
          @if (isEditMode()) {
            <h3>Gestion des documents</h3>
            <p class="section-description">Vous pouvez t√©l√©charger de nouveaux documents ou remplacer les documents existants.</p>
          } @else {
            <h3>Documents manquants</h3>
            <p class="section-description">Veuillez t√©l√©charger les documents manquants pour compl√©ter le dossier de stage.</p>
          }
          
          <div class="upload-grid two-columns">
            <!-- Convention -->
            @if (!conventionPreviewUrl() || isEditMode()) {
              <div class="document-upload-section">
                <h4>
                  Convention 
                  @if (conventionPreviewUrl() && isEditMode()) {
                    <span class="replace-indicator">(Remplacer)</span>
                  } @else {
                    <span class="required-later">(Requis)</span>
                  }
                </h4>
                @if (conventionPreviewUrl() && isEditMode()) {
                  <div class="current-document">
                    <span class="current-doc-label">Document actuel:</span>
                    <a [href]="conventionPreviewUrl()" target="_blank" class="current-doc-link">
                      üìÑ Convention existante
                    </a>
                  </div>
                }
                <div class="mini-upload-area" 
                     (dragover)="onDocumentDragOver($event, 'convention')" 
                     (dragleave)="onDocumentDragLeave($event, 'convention')" 
                     (drop)="onDocumentDropped($event, 'convention')"
                     [class.dragover]="documentDragStates()['convention']">
                  <input 
                    type="file" 
                    #conventionInput
                    accept=".pdf,.doc,.docx" 
                    (change)="onDocumentSelected($event, 'convention')"
                    style="display: none"
                  >
                  
                  @if (!documents()['convention']) {
                    <div class="mini-upload-placeholder">
                      <i class="mini-upload-icon">üìÑ</i>
                      <p>
                        @if (conventionPreviewUrl() && isEditMode()) {
                          Remplacer la convention
                        } @else {
                          Convention de stage
                        }
                      </p>
                      <button type="button" class="mini-upload-btn" (click)="conventionInput.click()">
                        @if (conventionPreviewUrl() && isEditMode()) {
                          Remplacer
                        } @else {
                          T√©l√©charger
                        }
                      </button>
                      <small>PDF, DOC, DOCX</small>
                    </div>
                  } @else {
                    <div class="mini-file-preview">
                      <span class="mini-file-name">{{ documents()['convention']?.name }}</span>
                      <button type="button" class="mini-remove-btn" (click)="removeDocument('convention')">√ó</button>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Assurance -->
            @if (!assurancePreviewUrl() || isEditMode()) {
              <div class="document-upload-section">
                <h4>
                  Assurance 
                  @if (assurancePreviewUrl() && isEditMode()) {
                    <span class="replace-indicator">(Remplacer)</span>
                  } @else {
                    <span class="required-later">(Requis)</span>
                  }
                </h4>
                @if (assurancePreviewUrl() && isEditMode()) {
                  <div class="current-document">
                    <span class="current-doc-label">Document actuel:</span>
                    <a [href]="assurancePreviewUrl()" target="_blank" class="current-doc-link">
                      üõ°Ô∏è Assurance existante
                    </a>
                  </div>
                }
                <div class="mini-upload-area" 
                     (dragover)="onDocumentDragOver($event, 'assurance')" 
                     (dragleave)="onDocumentDragLeave($event, 'assurance')" 
                     (drop)="onDocumentDropped($event, 'assurance')"
                     [class.dragover]="documentDragStates()['assurance']">
                  <input 
                    type="file" 
                    #assuranceInput
                    accept=".pdf,.doc,.docx" 
                    (change)="onDocumentSelected($event, 'assurance')"
                    style="display: none"
                  >
                  
                  @if (!documents()['assurance']) {
                    <div class="mini-upload-placeholder">
                      <i class="mini-upload-icon">üõ°Ô∏è</i>
                      <p>
                        @if (assurancePreviewUrl() && isEditMode()) {
                          Remplacer l'assurance
                        } @else {
                          Attestation d'assurance
                        }
                      </p>
                      <button type="button" class="mini-upload-btn" (click)="assuranceInput.click()">
                        @if (assurancePreviewUrl() && isEditMode()) {
                          Remplacer
                        } @else {
                          T√©l√©charger
                        }
                      </button>
                      <small>PDF, DOC, DOCX</small>
                    </div>
                  } @else {
                    <div class="mini-file-preview">
                      <span class="mini-file-name">{{ documents()['assurance']?.name }}</span>
                      <button type="button" class="mini-remove-btn" (click)="removeDocument('assurance')">√ó</button>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Lettre de motivation -->
            @if (!lettreMotivationPreviewUrl() || isEditMode()) {
              <div class="document-upload-section">
                <h4>
                  Lettre de motivation 
                  @if (lettreMotivationPreviewUrl() && isEditMode()) {
                    <span class="replace-indicator">(Remplacer)</span>
                  } @else {
                    <span class="optional">(Optionnel)</span>
                  }
                </h4>
                @if (lettreMotivationPreviewUrl() && isEditMode()) {
                  <div class="current-document">
                    <span class="current-doc-label">Document actuel:</span>
                    <a [href]="lettreMotivationPreviewUrl()" target="_blank" class="current-doc-link">
                      ‚úâÔ∏è Lettre existante
                    </a>
                  </div>
                }
                <div class="mini-upload-area" 
                     (dragover)="onDocumentDragOver($event, 'lettre_motivation')" 
                     (dragleave)="onDocumentDragLeave($event, 'lettre_motivation')" 
                     (drop)="onDocumentDropped($event, 'lettre_motivation')"
                     [class.dragover]="documentDragStates()['lettre_motivation']">
                  <input 
                    type="file" 
                    #lettreMotivationInput
                    accept=".pdf,.doc,.docx" 
                    (change)="onDocumentSelected($event, 'lettre_motivation')"
                    style="display: none"
                  >
                  
                  @if (!documents()['lettre_motivation']) {
                    <div class="mini-upload-placeholder">
                      <i class="mini-upload-icon">‚úâÔ∏è</i>
                      <p>
                        @if (lettreMotivationPreviewUrl() && isEditMode()) {
                          Remplacer la lettre
                        } @else {
                          Lettre de motivation
                        }
                      </p>
                      <button type="button" class="mini-upload-btn" (click)="lettreMotivationInput.click()">
                        @if (lettreMotivationPreviewUrl() && isEditMode()) {
                          Remplacer
                        } @else {
                          T√©l√©charger
                        }
                      </button>
                      <small>PDF, DOC, DOCX</small>
                    </div>
                  } @else {
                    <div class="mini-file-preview">
                      <span class="mini-file-name">{{ documents()['lettre_motivation']?.name }}</span>
                      <button type="button" class="mini-remove-btn" (click)="removeDocument('lettre_motivation')">√ó</button>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- CV -->
            @if (isEditMode()) {
              <div class="document-upload-section">
                <h4>
                  CV 
                  @if (cvPreviewUrl()) {
                    <span class="replace-indicator">(Remplacer)</span>
                  } @else {
                    <span class="required-later">(Requis)</span>
                  }
                </h4>
                @if (cvPreviewUrl()) {
                  <div class="current-document">
                    <span class="current-doc-label">Document actuel:</span>
                    <a [href]="cvPreviewUrl()" target="_blank" class="current-doc-link">
                      üìÑ CV existant
                    </a>
                  </div>
                }
                <div class="mini-upload-area" 
                     (dragover)="onDocumentDragOver($event, 'cv')" 
                     (dragleave)="onDocumentDragLeave($event, 'cv')" 
                     (drop)="onDocumentDropped($event, 'cv')"
                     [class.dragover]="documentDragStates()['cv']">
                  <input 
                    type="file" 
                    #cvInput
                    accept=".pdf,.doc,.docx" 
                    (change)="onDocumentSelected($event, 'cv')"
                    style="display: none"
                  >
                  
                  @if (!documents()['cv']) {
                    <div class="mini-upload-placeholder">
                      <i class="mini-upload-icon">üìÑ</i>
                      <p>
                        @if (cvPreviewUrl()) {
                          Remplacer le CV
                        } @else {
                          CV du stagiaire
                        }
                      </p>
                      <button type="button" class="mini-upload-btn" (click)="cvInput.click()">
                        @if (cvPreviewUrl()) {
                          Remplacer
                        } @else {
                          T√©l√©charger
                        }
                      </button>
                      <small>PDF, DOC, DOCX</small>
                    </div>
                  } @else {
                    <div class="mini-file-preview">
                      <span class="mini-file-name">{{ documents()['cv']?.name }}</span>
                      <button type="button" class="mini-remove-btn" (click)="removeDocument('cv')">√ó</button>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Demande de stage -->
            @if (isEditMode()) {
              <div class="document-upload-section">
                <h4>
                  Demande de stage 
                  @if (demandeStagePreviewUrl()) {
                    <span class="replace-indicator">(Remplacer)</span>
                  } @else {
                    <span class="optional">(Optionnel)</span>
                  }
                </h4>
                @if (demandeStagePreviewUrl()) {
                  <div class="current-document">
                    <span class="current-doc-label">Document actuel:</span>
                    <a [href]="demandeStagePreviewUrl()" target="_blank" class="current-doc-link">
                      üìã Demande existante
                    </a>
                  </div>
                }
                <div class="mini-upload-area" 
                     (dragover)="onDocumentDragOver($event, 'demande_de_stage')" 
                     (dragleave)="onDocumentDragLeave($event, 'demande_de_stage')" 
                     (drop)="onDocumentDropped($event, 'demande_de_stage')"
                     [class.dragover]="documentDragStates()['demande_de_stage']">
                  <input 
                    type="file" 
                    #demandeStageInput
                    accept=".pdf,.doc,.docx" 
                    (change)="onDocumentSelected($event, 'demande_de_stage')"
                    style="display: none"
                  >
                  
                  @if (!documents()['demande_de_stage']) {
                    <div class="mini-upload-placeholder">
                      <i class="mini-upload-icon">üìã</i>
                      <p>
                        @if (demandeStagePreviewUrl()) {
                          Remplacer la demande
                        } @else {
                          Demande de stage
                        }
                      </p>
                      <button type="button" class="mini-upload-btn" (click)="demandeStageInput.click()">
                        @if (demandeStagePreviewUrl()) {
                          Remplacer
                        } @else {
                          T√©l√©charger
                        }
                      </button>
                      <small>PDF, DOC, DOCX</small>
                    </div>
                  } @else {
                    <div class="mini-file-preview">
                      <span class="mini-file-name">{{ documents()['demande_de_stage']?.name }}</span>
                      <button type="button" class="mini-remove-btn" (click)="removeDocument('demande_de_stage')">√ó</button>
                    </div>
                  }
                </div>
              </div>
            }

          </div>
          
          <!-- Upload Action Button -->
          @if (hasDocumentsToUpload()) {
            <div class="upload-actions">
              <button 
                (click)="uploadDocuments()" 
                [disabled]="isUploading()"
                class="btn btn-primary upload-btn">
                @if (isUploading()) {
                  <span class="loading-spinner"></span>
                  T√©l√©chargement en cours...
                } @else {
                  üì§ T√©l√©charger les documents
                }
              </button>
            </div>
          }
        </div>
      }

    </div>
  }
